<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.2-20121118"/>
<title>framework: Discussion</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">framework
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.2-20121118 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">Mainpage documentation</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Discussion </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#serializable_zero_overhead">Zero overhead</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="serializable_zero_overhead"></a>
Zero overhead</h1>
<p>One of the design goals of this library was to keep the implementation as close to zero-overhead as possible. As such, it is worth examining how well this library achieves this goal. To begin, we will examine the overhead associated with variable access relative to that of a simple C structure. The following test code was used to isolate these operations to individual functions using GCC's noinline attribute:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="serializable_8hpp.html" title="Common serializable includes.">framework/serializable.hpp</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="stl__string_8hpp.html" title="Common STL string aliases.">framework/serializable/mutators/stl_string.hpp</a>&gt;</span></div>
<div class="line"></div>
<div class="line">using ::framework::serializable::inline_object;</div>
<div class="line">using ::framework::serializable::value;</div>
<div class="line"><a class="code" href="namespaceframework_1_1serializable.html#a9e424c9a7e9c6032083bd6b28a1a18ca" title="Get.">using ::framework::serializable::get</a>;</div>
<div class="line"><a class="code" href="namespaceframework_1_1serializable.html#a739eef06f5db7c8ed56fdcdaa25bed82" title="Set.">using ::framework::serializable::set</a>;</div>
<div class="line">    </div>
<div class="line"><span class="keyword">struct </span>s1</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> x;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">using</span> s2 = inline_object &lt;</div>
<div class="line">    value &lt;NAME(<span class="stringliteral">&quot;x&quot;</span>), <span class="keywordtype">int</span>&gt;&gt;;</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keywordtype">void</span> assignment_control (T&amp; in) __attribute__ ((noinline));</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keywordtype">void</span> assignment_test (T&amp; in) __attribute__ ((noinline));</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keywordtype">int</span> access_control (T&amp; in) __attribute__ ((noinline));</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keywordtype">int</span> access_test (T&amp; in) __attribute__ ((noinline));</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keywordtype">void</span> construction_control (T&amp; in) __attribute__ ((noinline));</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keywordtype">void</span> construction_test (T&amp; in) __attribute__ ((noinline));</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main ()</div>
<div class="line">{</div>
<div class="line">    s1 control{0};</div>
<div class="line">    s2 test{0};</div>
<div class="line"></div>
<div class="line">    std::cout &lt;&lt; access_control(control) &lt;&lt; std::endl;</div>
<div class="line">    std::cout &lt;&lt; access_test(test) &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">    assignment_control(control);</div>
<div class="line">    assignment_test(test);</div>
<div class="line"></div>
<div class="line">    std::cout &lt;&lt; control.x &lt;&lt; std::endl;</div>
<div class="line">    std::cout &lt;&lt; test.get &lt;NAME(<span class="stringliteral">&quot;x&quot;</span>)&gt; () &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">    construction_control(control);</div>
<div class="line">    construction_test(test);</div>
<div class="line">    </div>
<div class="line">    std::cout &lt;&lt; control.x &lt;&lt; std::endl;</div>
<div class="line">    std::cout &lt;&lt; test.get &lt;NAME(<span class="stringliteral">&quot;x&quot;</span>)&gt; () &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keywordtype">void</span> assignment_control (T&amp; in)</div>
<div class="line">{</div>
<div class="line">    in.x = 1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keywordtype">void</span> assignment_test (T&amp; in)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">set</span> &lt;NAME(<span class="stringliteral">&quot;x&quot;</span>)&gt; (in, 1);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keywordtype">int</span> access_control (T&amp; in)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> in.x;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keywordtype">int</span> access_test (T&amp; in)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">get</span> &lt;NAME(<span class="stringliteral">&quot;x&quot;</span>)&gt; (in);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keywordtype">void</span> construction_control (T&amp; in)</div>
<div class="line">{</div>
<div class="line">    T result{1234};</div>
<div class="line">    in = std::move(result);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keywordtype">void</span> construction_test (T&amp; in)</div>
<div class="line">{</div>
<div class="line">    T result{1234};</div>
<div class="line">    in = std::move(result);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Compiling the above using the following invocation of g++:</p>
<div class="fragment"><div class="line">g++ -std=c++11 -I./ -O2 ./examples/<a class="code" href="namespaceframework_1_1serializable.html#af3a77276bf43db604807844d1cde1562" title="Implementation alias.">serializable</a>/access_overhead.cpp</div>
</div><!-- fragment --><p>produces the following assembly, organized into test pairs:</p>
<div class="fragment"><div class="line">00000000004008b0 &lt;int access_control&lt;s1&gt;(s1&amp;)&gt;:</div>
<div class="line">4008b0: 8b 07                   mov    (%rdi),%eax</div>
<div class="line">4008b2: c3                      retq   </div>
<div class="line">4008b3: 66 2e 0f 1f 84 00 00    nopw   %cs:0x0(%rax,%rax,1)</div>
<div class="line">4008ba: 00 00 00 </div>
<div class="line">4008bd: 0f 1f 00                nopl   (%rax)</div>
<div class="line"></div>
<div class="line">00000000004008c0 &lt;int access_test&lt;framework: :serializable::inline_object&lt;framework::serializable::value&lt;framework::type_string&lt;(char)120&gt;, int, <a class="code" href="structframework_1_1serializable_1_1value__implementation.html" title="Default implementation.">framework::serializable::value_implementation</a>&gt; &gt; &gt;(<a class="code" href="exceptionframework_1_1serializable_1_1inline__object.html" title="Inline object wrapper.">framework::serializable::inline_object&lt;framework::serializable::value&lt;framework::type_string&lt;(char)120&gt;</a>, int, <a class="code" href="structframework_1_1serializable_1_1value__implementation.html" title="Default implementation.">framework::serializable::value_implementation</a>&gt; &gt;&amp;)&gt;:</div>
<div class="line">4008c0: 8b 07                   mov    (%rdi),%eax</div>
<div class="line">4008c2: c3                      retq   </div>
<div class="line">4008c3: 66 2e 0f 1f 84 00 00    nopw   %cs:0x0(%rax,%rax,1)</div>
<div class="line">4008ca: 00 00 00 </div>
<div class="line">4008cd: 0f 1f 00                nopl   (%rax)</div>
<div class="line"></div>
<div class="line">00000000004008d0 &lt;void assignment_control&lt;s1&gt;(s1&amp;)&gt;: </div>
<div class="line">4008d0: c7 07 01 00 00 00       movl   $0x1,(%rdi)</div>
<div class="line">4008d6: c3                      retq   </div>
<div class="line">4008d7: 66 0f 1f 84 00 00 00    nopw   0x0(%rax,%rax,1)</div>
<div class="line">4008de: 00 00 </div>
<div class="line"></div>
<div class="line">00000000004008e0 &lt;<span class="keywordtype">void</span> assignment_test&lt;framework: :serializable::inline_object&lt;<a class="code" href="structframework_1_1serializable_1_1value.html" title="Value container.">framework::serializable::value</a>&lt;<a class="code" href="structframework_1_1type__string.html" title="Type string.">framework::type_string</a>&lt;(<span class="keywordtype">char</span>)120&gt;, int, <a class="code" href="structframework_1_1serializable_1_1value__implementation.html" title="Default implementation.">framework::serializable::value_implementation</a>&gt; &gt; &gt;(framework::serializable::inline_object&lt;framework::serializable::value&lt;framework::type_string&lt;(char)120&gt;, int, <a class="code" href="structframework_1_1serializable_1_1value__implementation.html" title="Default implementation.">framework::serializable::value_implementation</a>&gt; &gt;&amp;)&gt;:</div>
<div class="line">4008e0: c7 07 01 00 00 00       movl   $0x1,(%rdi)</div>
<div class="line">4008e6: c3                      retq   </div>
<div class="line">4008e7: 66 0f 1f 84 00 00 00    nopw   0x0(%rax,%rax,1)</div>
<div class="line">4008ee: 00 00 </div>
<div class="line"></div>
<div class="line">00000000004008f0 &lt;<span class="keywordtype">void</span> construction_control&lt;s1&gt;(s1&amp;)&gt;: </div>
<div class="line">4008f0: c7 07 d2 04 00 00       movl   $0x4d2,(%rdi)</div>
<div class="line">4008f6: c3                      retq   </div>
<div class="line">4008f7: 66 0f 1f 84 00 00 00    nopw   0x0(%rax,%rax,1)</div>
<div class="line">4008fe: 00 00 </div>
<div class="line"></div>
<div class="line">0000000000400900 &lt;<span class="keywordtype">void</span> construction_test&lt;framework: :serializable::inline_object&lt;framework::serializable::value&lt;framework::type_string&lt;(char)120&gt;, int, <a class="code" href="structframework_1_1serializable_1_1value__implementation.html" title="Default implementation.">framework::serializable::value_implementation</a>&gt; &gt; &gt;(framework::serializable::inline_object&lt;framework::serializable::value&lt;framework::type_string&lt;(char)120&gt;, int, <a class="code" href="structframework_1_1serializable_1_1value__implementation.html" title="Default implementation.">framework::serializable::value_implementation</a>&gt; &gt;&amp;)&gt;:</div>
<div class="line">400900: c7 07 d2 04 00 00       movl   $0x4d2,(%rdi)</div>
<div class="line">400906: c3                      retq   </div>
<div class="line">400907: 66 0f 1f 84 00 00 00    nopw   0x0(%rax,%rax,1)</div>
<div class="line">40090e: 00 00</div>
</div><!-- fragment --><p>Note that in each test above produces identical control and test methods. The results above are hardly exhaustive, however it appears that in the very simple cases presented above GCC's was able to completely optimize out the abstraction achieving the secondary 'zero-overhead' design goal.</p>
<p>Next, we'll examine serialization operations. Here, a call to <code>read</code> or <code>write</code> invokes a series of static <code>serializable_specification</code> methods defined by the object's type. As such, the compiler's optimizer here is expected to be capable of producing code equivalent to invoking the underlying stream's read/write functions directly on a raw C structure. Again, examining only the simplest possible test case here:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;sstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cassert&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="serializable_8hpp.html" title="Common serializable includes.">framework/serializable.hpp</a>&gt;</span></div>
<div class="line"></div>
<div class="line">using ::framework::serializable::inline_object;</div>
<div class="line">using ::framework::serializable::value;</div>
<div class="line"><a class="code" href="namespaceframework_1_1serializable.html#a116938beb8e2e5e17ac3029a7b5c2e60" title="Read fowarder.">using ::framework::serializable::read</a>;</div>
<div class="line"><a class="code" href="namespaceframework_1_1serializable.html#a99b0af2f2f45ba69a1d6b7c7fc2dbb5e" title="Write forwarder.">using ::framework::serializable::write</a>;</div>
<div class="line">    </div>
<div class="line"><span class="keyword">struct </span>s1</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> x;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">using</span> s2 = inline_object &lt;</div>
<div class="line">    value &lt;NAME(<span class="stringliteral">&quot;x&quot;</span>), <span class="keywordtype">int</span>&gt;&gt;;</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> Output&gt;</div>
<div class="line"><span class="keywordtype">bool</span> write_control (T <span class="keyword">const</span>&amp; in, Output&amp; out) __attribute__ ((noinline));</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> Output&gt;</div>
<div class="line"><span class="keywordtype">bool</span> write_test (T <span class="keyword">const</span>&amp; in, Output&amp; out) __attribute__ ((noinline));</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Input, <span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keywordtype">bool</span> read_control (Input&amp; in, T&amp; out) __attribute__ ((noinline));</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Input, <span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keywordtype">bool</span> read_test (Input&amp; in, T&amp; out) __attribute__ ((noinline));</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main ()</div>
<div class="line">{</div>
<div class="line">    s1 <span class="keyword">const</span> control{1234};</div>
<div class="line">    s2 <span class="keyword">const</span> test{1234};</div>
<div class="line">    </div>
<div class="line">    s1 out_control{0};</div>
<div class="line">    s2 out_test{0};</div>
<div class="line">        </div>
<div class="line">    std::stringstream ss;</div>
<div class="line"></div>
<div class="line">    write_control(control, ss);</div>
<div class="line">    write_test(test, ss);</div>
<div class="line"></div>
<div class="line">    read_control(ss, out_control);</div>
<div class="line">    read_test(ss, out_test);</div>
<div class="line"></div>
<div class="line">    assert(control.x == out_control.x);</div>
<div class="line">    assert(test == out_test);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> Output&gt;</div>
<div class="line"><span class="keywordtype">bool</span> write_control (T <span class="keyword">const</span>&amp; in, Output&amp; out)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!out.write(reinterpret_cast &lt;char const*&gt; (&amp;in.x), <span class="keyword">sizeof</span>(in.x)))</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> Output&gt;</div>
<div class="line"><span class="keywordtype">bool</span> write_test (T <span class="keyword">const</span>&amp; in, Output&amp; out)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="namespaceframework_1_1serializable.html#a99b0af2f2f45ba69a1d6b7c7fc2dbb5e" title="Write forwarder.">write</a>(in, out);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Input, <span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keywordtype">bool</span> read_control (Input&amp; in, T&amp; out)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Note the default behaviour of read is to use a temporary in place of</span></div>
<div class="line">    <span class="comment">// out to avoid altering out&#39;s state on failure.  We need to reproduce</span></div>
<div class="line">    <span class="comment">// this behaviour here.</span></div>
<div class="line">    T tmp;</div>
<div class="line">    <span class="keywordflow">if</span> (!in.read(reinterpret_cast &lt;char*&gt; (&amp;tmp.x), <span class="keyword">sizeof</span>(tmp.x)))</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">    out = std::move(tmp);</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Input, <span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keywordtype">bool</span> read_test (Input&amp; in, T&amp; out)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="namespaceframework_1_1serializable.html#a116938beb8e2e5e17ac3029a7b5c2e60" title="Read fowarder.">read</a>(in, out);</div>
<div class="line">}</div>
</div><!-- fragment --><p>and compiling using the same invocation of g++:</p>
<div class="fragment"><div class="line">g++ -std=c++11 -I./ -O2 ./examples/<a class="code" href="namespaceframework_1_1serializable.html#af3a77276bf43db604807844d1cde1562" title="Implementation alias.">serializable</a>/access_overhead.cpp</div>
</div><!-- fragment --><p>produces the following assembly, organized into test pairs:</p>
<div class="fragment"><div class="line">0000000000400aa0 &lt;bool write_control&lt;s1, std: :basic_stringstream&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; &gt;(s1 <span class="keyword">const</span>&amp;, std::basic_stringstream&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;&amp;)&gt;:</div>
<div class="line">400aa0: 48 89 f8                mov    %rdi,%rax</div>
<div class="line">400aa3: 48 8d 7e 10             lea    0x10(%rsi),%rdi</div>
<div class="line">400aa7: 48 83 ec 08             sub    $0x8,%rsp</div>
<div class="line">400aab: ba 04 00 00 00          mov    $0x4,%edx</div>
<div class="line">400ab0: 48 89 c6                mov    %rax,%rsi</div>
<div class="line">400ab3: e8 88 fd ff ff          callq  400840 &lt;<a class="code" href="namespaceframework_1_1serializable.html#a99b0af2f2f45ba69a1d6b7c7fc2dbb5e" title="Write forwarder.">std::ostream::write</a>(<span class="keywordtype">char</span> <span class="keyword">const</span>*, <span class="keywordtype">long</span>)@plt&gt;</div>
<div class="line">400ab8: 48 8b 10                mov    (%rax),%rdx</div>
<div class="line">400abb: 48 8b 52 e8             mov    -0x18(%rdx),%rdx</div>
<div class="line">400abf: f6 44 10 20 05          testb  $0x5,0x20(%rax,%rdx,1)</div>
<div class="line">400ac4: 0f 94 c0                sete   %al</div>
<div class="line">400ac7: 48 83 c4 08             add    $0x8,%rsp</div>
<div class="line">400acb: c3                      retq   </div>
<div class="line">400acc: 0f 1f 40 00             nopl   0x0(%rax)</div>
<div class="line"></div>
<div class="line">0000000000400ad0 &lt;<span class="keywordtype">bool</span> write_test&lt;framework: :serializable::inline_object&lt;<a class="code" href="structframework_1_1serializable_1_1value.html" title="Value container.">framework::serializable::value</a>&lt;<a class="code" href="structframework_1_1type__string.html" title="Type string.">framework::type_string</a>&lt;(<span class="keywordtype">char</span>)120&gt;, int, <a class="code" href="structframework_1_1serializable_1_1value__implementation.html" title="Default implementation.">framework::serializable::value_implementation</a>&gt; &gt;, std::basic_stringstream&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; &gt;(framework::serializable::inline_object&lt;framework::serializable::value&lt;framework::type_string&lt;(char)120&gt;, int, framework::serializable::value_implementation&gt; &gt; <span class="keyword">const</span>&amp;, std::basic_stringstream&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;&amp;)&gt;:</div>
<div class="line">400ad0: 48 89 f8                mov    %rdi,%rax</div>
<div class="line">400ad3: 48 8d 7e 10             lea    0x10(%rsi),%rdi</div>
<div class="line">400ad7: 48 83 ec 08             sub    $0x8,%rsp</div>
<div class="line">400adb: ba 04 00 00 00          mov    $0x4,%edx</div>
<div class="line">400ae0: 48 89 c6                mov    %rax,%rsi</div>
<div class="line">400ae3: e8 58 fd ff ff          callq  400840 &lt;<a class="code" href="namespaceframework_1_1serializable.html#a99b0af2f2f45ba69a1d6b7c7fc2dbb5e" title="Write forwarder.">std::ostream::write</a>(<span class="keywordtype">char</span> <span class="keyword">const</span>*, <span class="keywordtype">long</span>)@plt&gt;</div>
<div class="line">400ae8: 48 8b 10                mov    (%rax),%rdx</div>
<div class="line">400aeb: 48 8b 52 e8             mov    -0x18(%rdx),%rdx</div>
<div class="line">400aef: f6 44 10 20 05          testb  $0x5,0x20(%rax,%rdx,1)</div>
<div class="line">400af4: 0f 94 c0                sete   %al</div>
<div class="line">400af7: 48 83 c4 08             add    $0x8,%rsp</div>
<div class="line">400afb: c3                      retq   </div>
<div class="line">400afc: 0f 1f 40 00             nopl   0x0(%rax)</div>
<div class="line"></div>
<div class="line">0000000000400b00 &lt;<span class="keywordtype">bool</span> read_control&lt;std: :basic_stringstream&lt;<span class="keywordtype">char</span>, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, s1&gt;(std::basic_stringstream&lt;<span class="keywordtype">char</span>, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;&amp;, s1&amp;)&gt;:</div>
<div class="line">400b00: 53                      push   %rbx</div>
<div class="line">400b01: ba 04 00 00 00          mov    $0x4,%edx</div>
<div class="line">400b06: 48 89 f3                mov    %rsi,%rbx</div>
<div class="line">400b09: 48 83 ec 10             sub    $0x10,%rsp</div>
<div class="line">400b0d: 48 89 e6                mov    %rsp,%rsi</div>
<div class="line">400b10: e8 0b fd ff ff          callq  400820 &lt;<a class="code" href="namespaceframework_1_1serializable.html#a116938beb8e2e5e17ac3029a7b5c2e60" title="Read fowarder.">std::istream::read</a>(<span class="keywordtype">char</span>*, <span class="keywordtype">long</span>)@plt&gt;</div>
<div class="line">400b15: 48 89 c2                mov    %rax,%rdx</div>
<div class="line">400b18: 48 8b 00                mov    (%rax),%rax</div>
<div class="line">400b1b: 48 8b 48 e8             mov    -0x18(%rax),%rcx</div>
<div class="line">400b1f: 31 c0                   xor    %eax,%eax</div>
<div class="line">400b21: f6 44 0a 20 05          testb  $0x5,0x20(%rdx,%rcx,1)</div>
<div class="line">400b26: 75 0a                   jne    400b32 &lt;bool read_control&lt;std::basic_stringstream&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, s1&gt;(std::basic_stringstream&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;&amp;, s1&amp;)+0x32&gt;</div>
<div class="line">400b28: 8b 04 24                mov    (%rsp),%eax</div>
<div class="line">400b2b: 89 03                   mov    %eax,(%rbx)</div>
<div class="line">400b2d: b8 01 00 00 00          mov    $0x1,%eax</div>
<div class="line">400b32: 48 83 c4 10             add    $0x10,%rsp</div>
<div class="line">400b36: 5b                      pop    %rbx</div>
<div class="line">400b37: c3                      retq   </div>
<div class="line">400b38: 0f 1f 84 00 00 00 00    nopl   0x0(%rax,%rax,1)</div>
<div class="line">400b3f: 00 </div>
<div class="line"></div>
<div class="line">0000000000400b40 &lt;bool read_test&lt;std: :basic_stringstream&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, framework::serializable::inline_object&lt;framework::serializable::value&lt;framework::type_string&lt;(char)120&gt;, int, framework::serializable::value_implementation&gt; &gt; &gt;(std::basic_stringstream&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;&amp;, framework::serializable::inline_object&lt;framework::serializable::value&lt;framework::type_string&lt;(char)120&gt;, int, framework::serializable::value_implementation&gt; &gt;&amp;)&gt;:</div>
<div class="line">400b40: 53                      push   %rbx</div>
<div class="line">400b41: 48 89 f3                mov    %rsi,%rbx</div>
<div class="line">400b44: ba 04 00 00 00          mov    $0x4,%edx</div>
<div class="line">400b49: 48 83 ec 10             sub    $0x10,%rsp</div>
<div class="line">400b4d: 48 8d 74 24 0c          lea    0xc(%rsp),%rsi</div>
<div class="line">400b52: e8 c9 fc ff ff          callq  400820 &lt;<a class="code" href="namespaceframework_1_1serializable.html#a116938beb8e2e5e17ac3029a7b5c2e60" title="Read fowarder.">std::istream::read</a>(<span class="keywordtype">char</span>*, <span class="keywordtype">long</span>)@plt&gt;</div>
<div class="line">400b57: 48 89 c2                mov    %rax,%rdx</div>
<div class="line">400b5a: 48 8b 00                mov    (%rax),%rax</div>
<div class="line">400b5d: 48 8b 48 e8             mov    -0x18(%rax),%rcx</div>
<div class="line">400b61: 31 c0                   xor    %eax,%eax</div>
<div class="line">400b63: f6 44 0a 20 05          testb  $0x5,0x20(%rdx,%rcx,1)</div>
<div class="line">400b68: 75 0b                   jne    400b75 &lt;bool read_test&lt;std::basic_stringstream&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, framework::serializable::inline_object&lt;framework::serializable::value&lt;framework::type_string&lt;(char)120&gt;, int, framework::serializable::value_implementation&gt; &gt; &gt;(std::basic_stringstream&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;&amp;, framework::serializable::inline_object&lt;framework::serializable::value&lt;framework::type_string&lt;(char)120&gt;, int, framework::serializable::value_implementation&gt; &gt;&amp;)+0x35&gt;</div>
<div class="line">400b6a: 8b 44 24 0c             mov    0xc(%rsp),%eax</div>
<div class="line">400b6e: 89 03                   mov    %eax,(%rbx)</div>
<div class="line">400b70: b8 01 00 00 00          mov    $0x1,%eax</div>
<div class="line">400b75: 48 83 c4 10             add    $0x10,%rsp</div>
<div class="line">400b79: 5b                      pop    %rbx</div>
<div class="line">400b7a: c3                      retq   </div>
<div class="line">400b7b: 0f 1f 44 00 00          nopl   0x0(%rax,%rax,1)</div>
</div><!-- fragment --><p>Once again, aside from trivial differences the assembly produced for control and tests cases is identical; our zero overhead requirement is again satisfied.</p>
<p>Finally, we examine the default comparison operators. Given the results in the preceding test the results here are not particularly interesting. The compiler is again expected to be capable to inlining the comparison operators used here to produce code equivalent to a similar operation involving a raw C structure:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cassert&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="serializable_8hpp.html" title="Common serializable includes.">framework/serializable.hpp</a>&gt;</span></div>
<div class="line"></div>
<div class="line">using ::framework::serializable::inline_object;</div>
<div class="line">using ::framework::serializable::value;</div>
<div class="line"><a class="code" href="namespaceframework_1_1serializable.html#a116938beb8e2e5e17ac3029a7b5c2e60" title="Read fowarder.">using ::framework::serializable::read</a>;</div>
<div class="line"><a class="code" href="namespaceframework_1_1serializable.html#a99b0af2f2f45ba69a1d6b7c7fc2dbb5e" title="Write forwarder.">using ::framework::serializable::write</a>;</div>
<div class="line">    </div>
<div class="line"><span class="keyword">struct </span>s1</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> x;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">using</span> s2 = inline_object &lt;</div>
<div class="line">    value &lt;NAME(<span class="stringliteral">&quot;x&quot;</span>), <span class="keywordtype">int</span>&gt;&gt;;</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keywordtype">bool</span> compare_control (T <span class="keyword">const</span>&amp; lhs, T <span class="keyword">const</span>&amp; rhs) __attribute__ ((noinline));</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keywordtype">bool</span> compare_test (T <span class="keyword">const</span>&amp; lhs, T <span class="keyword">const</span>&amp; rhs) __attribute__ ((noinline));</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main ()</div>
<div class="line">{</div>
<div class="line">    s1 <span class="keyword">const</span> control_lhs{1}, control_rhs{2};</div>
<div class="line">    s2 <span class="keyword">const</span> test_lhs{1}, test_rhs{2};</div>
<div class="line"></div>
<div class="line">    assert(compare_control(control_lhs, control_rhs));</div>
<div class="line">    assert(compare_test(test_lhs, test_rhs));</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keywordtype">bool</span> compare_control (T <span class="keyword">const</span>&amp; lhs, T <span class="keyword">const</span>&amp; rhs)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> lhs.x &lt; rhs.x;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keywordtype">bool</span> compare_test (T <span class="keyword">const</span>&amp; lhs, T <span class="keyword">const</span>&amp; rhs)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> lhs &lt; rhs;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Again, compiling the above using the same invocation of g++:</p>
<div class="fragment"><div class="line">g++ -std=c++11 -I./ -O2 ./examples/<a class="code" href="namespaceframework_1_1serializable.html#af3a77276bf43db604807844d1cde1562" title="Implementation alias.">serializable</a>/access_overhead.cpp</div>
</div><!-- fragment --><p>produces the following assembly, organized into test pairs:</p>
<div class="fragment"><div class="line">00000000004007a0 &lt;bool compare_control&lt;s1&gt;(s1 <span class="keyword">const</span>&amp;, s1 <span class="keyword">const</span>&amp;)&gt;: </div>
<div class="line">4007a0: 8b 06                   mov    (%rsi),%eax</div>
<div class="line">4007a2: 39 07                   cmp    %eax,(%rdi)</div>
<div class="line">4007a4: 0f 9c c0                setl   %al</div>
<div class="line">4007a7: c3                      retq   </div>
<div class="line">4007a8: 0f 1f 84 00 00 00 00    nopl   0x0(%rax,%rax,1)</div>
<div class="line">4007af: 00 </div>
<div class="line"></div>
<div class="line">00000000004007b0 &lt;bool compare_test&lt;framework: :serializable::inline_object&lt;framework::serializable::value&lt;framework::type_string&lt;(char)120&gt;, int, framework::serializable::value_implementation&gt; &gt; &gt;(framework::serializable::inline_object&lt;framework::serializable::value&lt;framework::type_string&lt;(char)120&gt;, int, framework::serializable::value_implementation&gt; &gt; <span class="keyword">const</span>&amp;, framework::serializable::inline_object&lt;framework::serializable::value&lt;framework::type_string&lt;(char)120&gt;, int, framework::serializable::value_implementation&gt; &gt; <span class="keyword">const</span>&amp;)&gt;:</div>
<div class="line">4007b0: 8b 06                   mov    (%rsi),%eax</div>
<div class="line">4007b2: 39 07                   cmp    %eax,(%rdi)</div>
<div class="line">4007b4: 0f 9c c0                setl   %al</div>
<div class="line">4007b7: c3                      retq   </div>
<div class="line">4007b8: 0f 1f 84 00 00 00 00    nopl   0x0(%rax,%rax,1)</div>
<div class="line">4007bf: 00</div>
</div><!-- fragment --><p>That is, our zero-overhead requirement is again satisfied in the above test cases as expected. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Dec 24 2012 10:32:07 for framework by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.2-20121118
</small></address>
</body>
</html>
